"use strict";angular.module("cinemaApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","uiGmapgoogle-maps","ngAutocomplete","geocoder","ngFitText","youtube-embed","LocalStorageModule","angularMoment","angulartics","angulartics.segment.io","ui.bootstrap","ngFitText"]).config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode(!0),a.when("/",{templateUrl:"views/main-new.html",controller:"MainNewCtrl"}).otherwise({redirectTo:"/"})}]).config(["localStorageServiceProvider",function(a){a.setPrefix("ls")}]).config(["$provide",function(a){a.decorator("$q",["$delegate",function(a){var b=a;return b.allComplete=function(a){if(!angular.isArray(a))throw Error("$q.allComplete only accepts an array.");var c=b.defer(),d=0,e=0,f=[];return angular.forEach(a,function(b){b.then(function(a){console.info("done",a),d++,f.push(a)}).catch(function(a){console.error("err",a),e++,f.push(a)}).finally(function(){d+e==a.length&&(console.log("COMPLETE: passed = "+d+", failed = "+e),c.resolve(f))})}),c.promise},b}])}]),angular.module("cinemaApp").service("Proxy",["$http",function(a){this.get=function(b){var c="http://moviehunterproxy.jit.su/?url=",d=a.get(c+b).then(function(a){return a.data});return d}}]),angular.module("cinemaApp").factory("tempData",function(){var a={};return{saveData:function(b,c){a[b]=c},getData:function(b){return a[b]}}}).factory("choices",["localStorageService",function(a){var b={};return{saveChoice:function(c,d){b[c]=d,a.add(c,d)},getData:function(c){return a.get(c)?a.get(c):b[c]}}}]),angular.module("cinemaApp").service("PostcodeValidator",function(){this.check=function(a){var b="[abcdefghijklmnoprstuwyz]",c="[abcdefghklmnopqrstuvwxy]",d="[abcdefghjkpmnrstuvwxy]",e="[abehmnprvwxy]",f="[abdefghjlnpqrstuwxyz]",g="[abdefghjlnpqrst]",h="[abdefghjlnpqrstuwzyz]",i=[];i.push(new RegExp("^(bf1)(\\s*)([0-6]{1}"+g+"{1}"+h+"{1})$","i")),i.push(new RegExp("^("+b+"{1}"+c+"?[0-9]{1,2})(\\s*)([0-9]{1}"+f+"{2})$","i")),i.push(new RegExp("^("+b+"{1}[0-9]{1}"+d+"{1})(\\s*)([0-9]{1}"+f+"{2})$","i")),i.push(new RegExp("^("+b+"{1}"+c+"{1}?[0-9]{1}"+e+"{1})(\\s*)([0-9]{1}"+f+"{2})$","i")),i.push(/^(GIR)(\s*)(0AA)$/i),i.push(/^(bfpo)(\s*)([0-9]{1,4})$/i),i.push(/^(bfpo)(\s*)(c\/o\s*[0-9]{1,3})$/i),i.push(/^([A-Z]{4})(\s*)(1ZZ)$/i),i.push(/^(ai-2640)$/i);for(var j=!1,k=0;k<i.length;k++)if(i[k].test(a)){i[k].exec(a),a=RegExp.$1.toUpperCase()+" "+RegExp.$3.toUpperCase(),a=a.replace(/C\/O\s*/,"c/o "),"AI-2640"===a.toUpperCase()&&(a="AI-2640"),j=!0;break}return j?a:!1}}),angular.module("ngAutocomplete",[]).directive("ngAutocomplete",function(){return{require:"ngModel",scope:{ngModel:"=",options:"=?",details:"=?"},link:function(a,b,c,d){var e,f=!1,g=function(){e={},a.options&&(f=a.options.watchEnter!==!0?!1:!0,a.options.types?(e.types=[],e.types.push(a.options.types),a.gPlace.setTypes(e.types)):a.gPlace.setTypes([]),a.options.bounds?(e.bounds=a.options.bounds,a.gPlace.setBounds(e.bounds)):a.gPlace.setBounds(null),a.options.country?(e.componentRestrictions={country:a.options.country},a.gPlace.setComponentRestrictions(e.componentRestrictions)):a.gPlace.setComponentRestrictions(null))};void 0==a.gPlace&&(a.gPlace=new google.maps.places.Autocomplete(b[0],{})),google.maps.event.addListener(a.gPlace,"place_changed",function(){var c=a.gPlace.getPlace();void 0!==c&&(void 0!==c.address_components?a.$apply(function(){a.details=c,d.$setViewValue(b.val())}):f&&h(c))});var h=function(c){var e=new google.maps.places.AutocompleteService;c.name.length>0&&e.getPlacePredictions({input:c.name,offset:c.name.length},function(c){if(null==c||0==c.length)a.$apply(function(){a.details=null});else{var e=new google.maps.places.PlacesService(b[0]);e.getDetails({reference:c[0].reference},function(c,e){e==google.maps.GeocoderStatus.OK&&a.$apply(function(){d.$setViewValue(c.formatted_address),b.val(c.formatted_address),a.details=c;b.on("focusout",function(){b.val(c.formatted_address),b.unbind("focusout")})})})}})};d.$render=function(){var a=d.$viewValue;b.val(a)},a.watchOptions=function(){return a.options},a.$watch(a.watchOptions,function(){g()},!0)}}}),angular.module("geocoder",["ngStorage"]).factory("Geocoder",["$localStorage","$q","$timeout","$rootScope",function(a,b,c,d){var e=a.locations?JSON.parse(a.locations):{},f=[],g=250,h=function(){console.log("executing next");var b=f[0],i=new google.maps.Geocoder;i.geocode({address:b.address,componentRestrictions:{country:"GB"}},function(i,j){if("United Kingdom"===i[0].formatted_address)f.shift(),b.d.reject({type:"zero",message:"Zero results for geocoding address "+b.address});else if(j===google.maps.GeocoderStatus.OK){var k={lat:i[0].geometry.location.lat(),lng:i[0].geometry.location.lng(),formattedAddress:i[0].formatted_address};e[b.address]=k,a.locations=JSON.stringify(e),f.shift(),b.d.resolve(k)}else j===google.maps.GeocoderStatus.ZERO_RESULTS?(f.shift(),b.d.reject({type:"zero",message:"Zero results for geocoding address "+b.address})):j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT?b.executedAfterPause&&(f.shift(),b.d.reject({type:"busy",message:"Geocoding server is busy can not process address "+b.address})):j===google.maps.GeocoderStatus.REQUEST_DENIED?(f.shift(),b.d.reject({type:"denied",message:"Request denied for geocoding address "+b.address})):(f.shift(),b.d.reject({type:"invalid",message:"Invalid request for geocoding: status="+j+", address="+b.address}));if(f.length)if(j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT){var l=f[0];l.executedAfterPause=!0,c(h,g)}else c(h,0);d.$$phase||d.$apply()})};return{latLngForAddress:function(a){console.log("will geocode",a);var c=b.defer();return _.has(e,a)?c.resolve(e[a]):(f.push({address:a,d:c}),1===f.length&&h()),c.promise}}}]),angular.module("cinemaApp").factory("collatedata",["$rootScope","Proxy","$q","localStorageService","getMovieData",function(a,b,c,d,e){var f={};f.list={},f.partiallyBuilt=!1;var g=/[a-zA-Z0-9'\-:& ]+/,h=function(e,h){f.startedBuilding=!0,console.log("Loading movie data in the background");for(var j=[],k=0;k<e.length;k+=1){var l="http://moviesapi.herokuapp.com/cinemas/"+e[k].venue_id+"/showings",m=b.get(l);j.push(m)}c.all(j).then(function(b){for(var c=0;c<b.length;c+=1)for(var d=e[c],j=b[c],k=0;k<j.length;k+=1){var l=j[k];if(f.list[l.link]){f.list[l.link].cinemas[d.venue_id]={};var m=[d.title,d.distance,d.address,d.link];f.list[l.link].cinemas[d.venue_id].info=m,f.list[l.link].cinemas[d.venue_id].times=l.time}else{f.list[l.link]={},f.list[l.link].cinemas={},f.list[l.link].cinemas[d.venue_id]={};var m=[d.title,d.distance,d.address,d.link];f.list[l.link].cinemas[d.venue_id].info=m,f.list[l.link].cinemas[d.venue_id].times=l.time,console.log(l.title),f.list[l.link].title=l.title.match(g)[0],f.list[l.link].link=l.link,i(l.link,l.title.match(g)[0],h)}f.partiallyBuilt===!1&&(a.$broadcast("firstFilmStored"),console.log("setting partiallyBuilt to true!!!"),f.partiallyBuilt=!0)}}).then(function(){f.collated=!0,d.add("movies"+h,f)})},i=function(a,b,c){console.log("will apply movie data for ",b),e.getData(b).then(function(b){f.list[a].details=b,d.add("movies"+c,f)})};return{createMovieList:h,movieList:f.list,getMovieList:function(a){return d.get("movies"+a)?(console.log("Getting cached data instead. update this to check for staleness"),d.get("movies"+a)):f}}}]),angular.module("cinemaApp").directive("fadingControls",["$timeout",function(a){return{restrict:"A",link:function(b,c){var d=[];b.$on("loaded",function(){for(var b=0;b<d.length;b+=1)a.cancel(d[b]),d.shift();a(function(){c.addClass("hidden")},3e3)}),c.bind("mouseover",function(){for(var b=0;b<d.length;b+=1)a.cancel(d[b]),d.shift();c.removeClass("hidden");var e=a(function(){c.addClass("hidden")},4500);d.push(e)})}}}]),angular.module("cinemaApp").filter("trimWords",function(){return function(a,b){for(var b=b||1,c=a.split(" "),d=[],e=0;b>e;e+=1)d.push(c[e]);return d.join(" ")}}),angular.module("cinemaApp").filter("splitOnCommas",function(){return function(a,b){for(var b=b||0,c=a.split(", "),d=[],e=0;b+1>e;e+=1)d.push(c[e]);return d.join(", ")}}),angular.module("cinemaApp").factory("Directions",["$q",function(a){var b=new google.maps.DirectionsService,c=function(c,d){var e=a.defer(),f=new google.maps.LatLng(c.lat,c.lng),g=new google.maps.LatLng(d.lat,d.lng),h={origin:f,destination:g,travelMode:google.maps.TravelMode.DRIVING};return b.route(h,function(a){console.log(a),e.resolve(a)}),e.promise};return{doRequest:c}}]),angular.module("cinemaApp").directive("errorMessage",["$timeout",function(a){return{template:'<div class="alert-box alert hidden text-center"></div>',restrict:"E",replace:!0,link:function(b,c){b.$on("error",function(){c.removeClass("hidden"),c.text("Sorry, we couldn't find that address"),a(function(){c.addClass("hidden")},2e3)})}}}]),angular.module("cinemaApp").controller("MainNewCtrl",["$scope","$location","$q","$timeout","Proxy","Geocoder","tempData","choices","localStorageService","collatedata","geolocation",function(a,b,c,d,e,f,g,h,i,j,k){var l={map:[]};a.mapEvents={tilesloaded:function(b){a.$apply(function(){a.mapInstance=b})},dragend:function(b){for(var c=0;c<l.map.length;c++)d.cancel(l.map[c]);var e=d(function(){a.showSearchResults(b.center.k,b.center.D)},700);l.map.push(e)}},a.playerVars={autoplay:1,showinfo:0,controls:0,iv_load_policy:3,rel:0,modestbranding:1},a.youtubePlayer={player:null},a.events={click:function(b,c,d){n(d.id),a.filtered=!0}};var m=function(b,c){b=b?b:51.5,c=c?c:-.1167,a.map={center:{latitude:b,longitude:c},zoom:11},a.marker={id:0,coords:{latitude:b,longitude:c},options:{draggable:!0,visible:!0,title:'"There\'s no place like home"',zIndex:1e3}}};m(),a.cinemaMarkers=[];var n=function(b){for(var c in a.movieList){var d=a.movieList[c].cinemas[b];a.movieList[c].chosenCinemaTimes=null,a.movieList[c].chosenCinema=null}if(a.storedMovieList)var e=a.storedMovieList;else a.storedMovieList=a.movieList;a.movieList=_.filter(e,function(a){var c=_.keys(a.cinemas);return _.contains(c,b)?!0:void 0});for(var c in a.movieList){var d=a.movieList[c].cinemas[b];a.movieList[c].chosenCinemaTimes=d.times,a.movieList[c].chosenCinema=d.info[0]}};a.resetCinemas=function(){a.cinemaMarkers=a.fullCinemaMarkers,a.filterOptions={filtered:!1,movie:null}},a.openTrailer=function(b){a.youtubeId=b},a.closeTrailer=function(){a.youtubeId=null},a.resetFilter=function(){a.movieList=a.storedMovieList,a.filtered=!1},a.highlightCinemas=function(b,c){var d=g.getData("postcode"),e=i.get("cinemaList"+d);a.filterOptions={filtered:!0,movie:c.title};for(var f=_.filter(e,function(a){return _.contains(_.keys(b),a.venue_id)}),h=0;h<f.length;h++)f[h].movieTimes=c.cinemas[f[h].venue_id].times,f[h].movieTitle=c.title;p(f)};var o=function(b){console.log(a.movieList);_.filter(a.movieList,function(a){var c=_.keys(a.cinemas);return _.contains(c,b)?!0:void 0})},p=function(b){a.cinemaMarkers=[],a.cinemaWindows=[];for(var c=0;c<b.length;c++){o(b[c].venue_id);var d={id:b[c].venue_id,title:b[c].title,options:{title:b[c].title,random:"blah blah blah"},clickable:!0,latitude:b[c].coords.lat,longitude:b[c].coords.lng,icon:"images/cinema_icons/cinema.png"};b[c].movieTitle||(b[c].movieTitle="");var e={movieTitle:b[c].movieTitle,movieTimes:b[c].movieTimes,stuff:"from props"},f={id:b[c].venue_id,coords:{latitude:b[c].coords.lat,longitude:b[c].coords.lng},options:{},show:!0,templateUrl:"views/info-window.html",templateParameter:e,isIconVisibleOnClick:!0,closeClick:"none"};a.cinemaWindows.push(f),a.cinemaMarkers.push(d)}};a.$on("youtube.player.paused",function(){a.videoPaused=!0}),a.$on("youtube.player.playing",function(){a.videoPaused=!1}),a.controlVideo=function(){a.videoPaused===!0?(a.videoPaused=!1,a.youtubePlayer.player.playVideo()):(a.videoPaused=!0,a.youtubePlayer.player.pauseVideo())},navigator.geolocation&&(a.geolocationFeature=!0),a.getLocation=function(){navigator.geolocation?(navigator.geolocation.getCurrentPosition(q,r),a.searching=1,a.address="Finding your address automatically..."):console.log("Geolocation is not available in this browser, please type your postcode manually")};var q=function(b){a.searching=1;var c=b.coords.latitude,d=b.coords.longitude;a.usedGeolocation=!0,a.showSearchResults(c,d)},r=function(){console.log("Geolocation failed or permission was denied")};a.doSearch=function(){a.searching=1,f.latLngForAddress(a.address).then(function(b){a.showSearchResults(b.lat,b.lng)},function(){a.loading=0})};var s=function(){a.loading=0},t=function(b,d){var f=c.defer(),i="https://api.postcodes.io/postcodes/lon/"+d+"/lat/"+b+"&radius=999";return console.log("url",i),e.get(i).then(function(c){if(!c.result)throw s(),a.loading=0,f.reject(),new Error("Postcode API returned blank with data:",c);var e=c.result[0].outcode+" "+c.result[0].incode;a.usedGeolocation===!0&&(a.address=e),a.loading=1,a.postcode=e,e=e.split(" ").join(""),g.saveData("postcode",e),h.saveChoice("postcode",e),g.saveData("latlong",{lat:b,lng:d}),f.resolve(e)}),f.promise},u=function(b){var c=i.get("cinemaList"+b);p(c),a.fullCinemaMarkers=_.clone(a.cinemaMarkers,!0),j.getMovieList(b)?a.movieList=j.getMovieList(b).list:j.createMovieList(i.get("cinemaList"+b),b),a.loading=2};a.showSearchResults=function(b,d){console.log("searching",b,d),t(b,d).then(function(g){if(m(b,d),a.loading=1,a.searching=0,i.get("cinemaList"+g))return void u(g);var h="http://moviesapi.herokuapp.com/cinemas/find/"+g;e.get(h).then(function(b){for(var d=[],e=0;e<b.length;e+=1)d.push(f.latLngForAddress(b[e].address));c.allComplete(d).then(function(c){for(var d=0;d<c.length;d+=1)b[d].coords=c[d];var e=b;p(e),a.fullCinemaMarkers=_.clone(a.cinemaMarkers,!0),i.add("cinemaList"+g,e),a.loading=2},function(a){console.log("Failed to get cinema coordinates",a.type,a.message)}),j.createMovieList(b,g),a.movieList=j.movieList,console.log(a.movieList)})},function(){console.log("We got an error with the postcode")})};var v=function(){k.get().then(function(b){a.showSearchResults(b.latitude,b.longitude)})};v()}]),angular.module("cinemaApp").factory("getMovieData",["Proxy","$q",function(a,b){var c=function(c){var d=b.defer(),e=/[a-zA-Z0-9'\-:& ]+/,c=c.match(e)[0],f="https://www.googleapis.com/youtube/v3/",g=encodeURIComponent("search?part=id%2Csnippet&q="+c+"%20movie%20trailer&key=AIzaSyBSLdvbrkkvY7Ft9ZYhgUqoSoBlak2A9HY"),h=f+g;return a.get(h).then(function(a){d.resolve(a.items[0].id.videoId)}),d.promise},d=function(c){var d=b.defer(),e=/[a-zA-Z0-9'\-:& ]+/,c=c.match(e)[0],f="http://api.rottentomatoes.com/",g=encodeURIComponent("api/public/v1.0/movies.json?apikey=cbjztdb4a23whxw8maup8ne5&q="+c);return a.get(f+g).then(function(a){if(a.movies&&a.movies[0]){var b={};b.runtime=a.movies[0].runtime,b.rating=a.movies[0].ratings.critics_score>=0?a.movies[0].ratings.critics_score:" --",b.rtId=a.movies[0].id;var c=a.movies[0].posters.thumbnail;b.poster=c.replace(/_tmb/i,"_pro"),d.resolve(b)}}),d.promise},e=function(c){var d=b.defer(),e=/[a-zA-Z0-9'\-:& ]+/,f=c.match(e)[0],g="http://omdbapi.com/?t=",h=encodeURIComponent(f);return a.get(g+h).then(function(a){var b={};b.rating=a.imdbRating,b.rating=a.imdbRating?"N/A"===a.imdbRating?" --":a.imdbRating:" --",b.actors=a.Actors,b.genre=a.Genre?a.Genre.split(","):["Unknown"],b.imdbId=a.imdbID,b.synopsis="N/A"===a.Plot?"No summary available":a.Plot,d.resolve(b)}),d.promise},f=function(a){var f=b.defer();console.log("getting data for",a);var g=[e(a),d(a),c(a)];return b.all(g).then(function(b){console.log("returned data for ",a,b);var c={imdb:b[0],rt:b[1],youtube:b[2]};f.resolve(c)},function(b){console.log(a,"failed",b)}),f.promise};return{getData:f}}]),angular.module("cinemaApp").filter("selectedGenres",function(){return function(a,b){return a.filter(function(a){for(var c in a.Genres)if(b.indexOf(a.Genres[c])>-1)return!0;return!1})}}),angular.module("cinemaApp").factory("geolocation",["$q","$http",function(a,b){function c(){var c=a.defer();return b.get("http://www.telize.com/geoip").then(function(a){var b={latitude:a.data.latitude,longitude:a.data.longitude};c.resolve(b)}),c.promise}return{get:c}}]),angular.module("cinemaApp").directive("expand",["$rootScope",function(a){return{restrict:"A",link:function(b,c,d){b.$watch("open",function(b){c.css("height",b?"auto":d.fixedheight),a.$emit("contract",c)}),c.css("height",d.fixedheight),a.$on("contract",function(a,b){c!=b&&c.css("height",d.fixedheight)})}}}]);