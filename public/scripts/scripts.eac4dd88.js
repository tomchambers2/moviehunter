"use strict";window.prerenderReady=!1,angular.module("cinemaApp",["ngRoute","geocoder","youtube-embed","angulartics","angulartics.segment.io","angular-lodash","angularMoment","ngPourOver","autocomplete"]).constant("angularMomentConfig",{timezone:"Europe/London"}).config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode({enabled:!0,requireBase:!1}),a.when("/",{templateUrl:"/views/main.html",controller:"MainCtrl"}).when("/cinema/:cinema/:movie",{templateUrl:"/views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).when("/cinema/:cinema",{templateUrl:"/views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).when("/movie/:movie",{templateUrl:"/views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).when("/:location/:movie",{templateUrl:"/views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).when("/:location",{templateUrl:"/views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).otherwise({redirectTo:"/"})}]).config(["$provide",function(a){a.decorator("$q",["$delegate",function(a){var b=a;return b.allComplete=function(a){if(!angular.isArray(a))throw Error("$q.allComplete only accepts an array.");var c=b.defer(),d=0,e=0,f=[];return angular.forEach(a,function(b){b.then(function(a){console.info("done",a),d++,f.push(a)}).catch(function(a){console.error("err",a),e++,f.push(a)}).finally(function(){d+e===a.length&&c.resolve(f)})}),c.promise},b}])}]).run(["$route","$rootScope","$location",function(a,b,c){var d=c.path;c.path=function(e,f){if(f===!1)var g=a.current,h=b.$on("$locationChangeSuccess",function(){a.current=g,h()});return d.apply(c,[e])}}]),angular.module("ngAutocomplete",[]).directive("ngAutocomplete",function(){return{require:"ngModel",scope:{ngModel:"=",options:"=?",details:"=?"},link:function(a,b,c,d){var e,f=!1,g=function(){e={},a.options&&(f=a.options.watchEnter!==!0?!1:!0,a.options.types?(e.types=[],e.types.push(a.options.types),a.gPlace.setTypes(e.types)):a.gPlace.setTypes([]),a.options.bounds?(e.bounds=a.options.bounds,a.gPlace.setBounds(e.bounds)):a.gPlace.setBounds(null),a.options.country?(e.componentRestrictions={country:a.options.country},a.gPlace.setComponentRestrictions(e.componentRestrictions)):a.gPlace.setComponentRestrictions(null))};void 0==a.gPlace&&(a.gPlace=new google.maps.places.Autocomplete(b[0],{})),google.maps.event.addListener(a.gPlace,"place_changed",function(){var c=a.gPlace.getPlace();void 0!==c&&(void 0!==c.address_components?a.$apply(function(){a.details=c,d.$setViewValue(b.val())}):f&&h(c))});var h=function(c){var e=new google.maps.places.AutocompleteService;c.name.length>0&&e.getPlacePredictions({input:c.name,offset:c.name.length},function(c){if(null==c||0==c.length)a.$apply(function(){a.details=null});else{var e=new google.maps.places.PlacesService(b[0]);e.getDetails({reference:c[0].reference},function(c,e){e==google.maps.GeocoderStatus.OK&&a.$apply(function(){d.$setViewValue(c.formatted_address),b.val(c.formatted_address),a.details=c;b.on("focusout",function(){b.val(c.formatted_address),b.unbind("focusout")})})})}})};d.$render=function(){var a=d.$viewValue;b.val(a)},a.watchOptions=function(){return a.options},a.$watch(a.watchOptions,function(){g()},!0)}}}),angular.module("geocoder",["ngStorage"]).factory("Geocoder",["$localStorage","$q","$timeout","$rootScope",function(a,b,c,d){var e=a.locations?JSON.parse(a.locations):{},f=[],g=250,h=function(){console.log("executing next");var b=f[0],i=new google.maps.Geocoder;i.geocode({address:b.address,componentRestrictions:{country:"GB"}},function(i,j){if(console.log("RESULT",i),"United Kingdom"===i[0].formatted_address)f.shift(),b.d.reject({type:"zero",message:"Zero results for geocoding address "+b.address});else if(j===google.maps.GeocoderStatus.OK){var k={lat:i[0].geometry.location.lat(),lng:i[0].geometry.location.lng(),formattedAddress:i[0].formatted_address};e[b.address]=k,a.locations=JSON.stringify(e),f.shift(),b.d.resolve(k)}else j===google.maps.GeocoderStatus.ZERO_RESULTS?(f.shift(),b.d.reject({type:"zero",message:"Zero results for geocoding address "+b.address})):j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT?b.executedAfterPause&&(f.shift(),b.d.reject({type:"busy",message:"Geocoding server is busy can not process address "+b.address})):j===google.maps.GeocoderStatus.REQUEST_DENIED?(f.shift(),b.d.reject({type:"denied",message:"Request denied for geocoding address "+b.address})):(f.shift(),b.d.reject({type:"invalid",message:"Invalid request for geocoding: status="+j+", address="+b.address}));if(f.length)if(j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT){var l=f[0];l.executedAfterPause=!0,c(h,g)}else c(h,0);d.$$phase||d.$apply()})};return{latLngForAddress:function(a){var c=b.defer();return _.has(e,a)?c.resolve(e[a]):(f.push({address:a,d:c}),1===f.length&&h()),c.promise}}}]),angular.module("cinemaApp").directive("errorMessage",["$timeout",function(a){return{template:'<div class="alert-box alert hidden text-center"></div>',restrict:"E",replace:!0,link:function(b,c){b.$on("error",function(){c.removeClass("hidden"),c.text("Sorry, we couldn't find that address"),a(function(){c.addClass("hidden")},2e3)})}}}]),angular.module("cinemaApp").controller("MainCtrl",["$scope","$location","$routeParams","$q","$timeout","Geocoder","geolocation","PourOver",function(a,b,c,d,e,f,g){function h(){var b=new google.maps.LatLng(51.5,-.1167),c={zoom:14,minZoom:14,center:b},d=new google.maps.Map(document.getElementById("map-canvas"),c);a.map=d;var e={maxZoom:16,imageExtension:"png",imagePath:"/images/cinema_icons/cinema-stack"},f=new MarkerClusterer(d,[],e);a.mc=f,google.maps.event.addListener(d,"bounds_changed",function(){var a=this.getBounds(),b=a.getCenter(),c=a.getNorthEast(),d=3963,e=b.lat()/57.2958,f=b.lng()/57.2958,g=c.lat()/57.2958,h=c.lng()/57.2958,i=d*Math.acos(Math.sin(e)*Math.sin(g)+Math.cos(e)*Math.cos(g)*Math.cos(h-f)),j=1.609344*i;o.updateCriteria({radius:j})}),google.maps.event.addListener(d,"dragend",function(){t(),a.updateGeoQuery(this.center.k,this.center.D),u({coords:{lat:this.center.k,lng:this.center.D}})}),google.maps.event.addListener(d,"zoom_changed",function(){a.updateGeoQuery(this.center.k,this.center.D),u({coords:{lat:this.center.k,lng:this.center.D}})})}function i(b){a.youAreHereMarker&&a.youAreHereMarker.setMap(null),a.youAreHereMarker=new google.maps.Marker({position:{lat:b.lat,lng:b.lng},map:a.map,title:b.formattedAddress,id:"youAreHere"})}var j=new Firebase("https://movielistings.firebaseio.com/"),k=j.child("cinemas"),l=j.child("movies"),m=new GeoFire(j.child("cinemasGeofire"));a.loading="BANANSS";var n=2.813,o=m.query({center:[51.5,-.1167],radius:n});a.filters={moviename:""},a.movieNames=[],a.cinemasLoading=!0,a.selectedMovie=null,a.selectedCinema=null,a.selectedDay=moment().startOf("day").valueOf(),a.selectedDays={0:moment().startOf("day").valueOf(),1:moment().startOf("day").add(1,"days").valueOf(),2:moment().startOf("day").add(2,"days").valueOf(),3:moment().startOf("day").add(3,"days").valueOf()},a.selectedDayIndex=0,a.tomorrowPlus1=moment().startOf("day").add(2,"days").format("dddd"),a.tomorrowPlus2=moment().startOf("day").add(3,"days").format("dddd"),a.movieIds=[],a.movies=[],a.cinemas=[],a.cinemaMovies={},a.setMovienameFilter=function(){a.filters.moviename=a.searchMoviename},a.resetMovienameFilter=function(){a.searchMoviename="",a.filters.moviename=""},a.resetFilters=function(){a.searchMoviename="",a.selectedCinema=null,a.selectedMovie=null,a.filters.moviename=""},a.$on("selectedCinema",function(b,c){a.selectCinema({tid:c,dontReset:!0})}),a.filterByMovieIds=function(b){return a.movieIds.indexOf(b.id)>-1?!0:void 0},a.filterBySelectedCinema=function(b){return a.selectedCinema?b[a.selectedCinema]?!0:void 0:!0},a.selectDay=function(b){a.selectedDay=moment().add(b,"days").startOf("day").valueOf(),a.selectedDayIndex=parseInt(b,10)},o.on("key_entered",function(b){k.child(b).on("value",function(b){a.cinemasLoading=!1;var c=b.val();if(null!==c&&!_.findWhere(a.cinemas,{tid:c.tid})){if(a.cinemas.push(c),c.movies)for(var d=0;d<c.movies.length;d++)a.movieIds.push(c.movies[d]);a.$apply()}})}),o.on("key_exited",function(b){k.child(b).on("value",function(b){var c=b.val(),d=_.findWhere(a.cinemas,{tid:c.tid});if(a.cinemas.splice(a.cinemas.indexOf(d),1),null!==c&&c.movies)for(var e=0;e<c.movies.length;e++)c.movies[e]!==a.selectedMovie&&a.movieIds.splice(a.movieIds.indexOf(c.movies[e]),1)})}),l.on("child_added",function(b){var c=b.val();c.id=b.key(),a.movies.push(c),a.movieNames.push(c.title),a.$apply()});var p=function(a){return a.rt?"number"!=typeof a.rt.rating?-1:a.rt.rating:-1},q=function(a){if(!a.imdb)return-1;var b=parseFloat(a.imdb.rating);return"number"!=typeof b?-1:b},r=function(a){return a.rt.releaseDate?a.rt.releaseDateTimestamp:-1},s=function(a){return a.rt.releaseDate?-a.rt.releaseDateTimestamp:-1};a.filterFns=[{l:"Rotten Tomatoes rating",fn:p},{l:"IMDB rating",fn:q},{l:"Newest movies first",fn:r},{l:"Oldest movies first",fn:s}],a.filterFn=p,a.selectCinema=function(b){b.dontReset||a.resetFilters();var c;b.cinema||(c=_.findWhere(a.cinemas,{tid:b.tid}),u({cinema:c})),e(function(){a.selectedCinema=b.tid,a.selectedCinemaObject=b.cinema||c})};var t=function(){a.selectedCinema=null};a.filterCinemas=function(b){var c=_.findWhere(a.movies,{id:b.movie});b.updateUrl&&u({movie:c}),e(function(){a.selectedMovie=c.id,a.selectedMovieObject=c,a.filters.moviename=a.searchMoviename=c.title,b.cinema&&a.selectCinema({cinema:b.cinema,dontReset:!0})})},a.unfilterCinemas=function(){var c=b.path(),d=c.match(/^(\/[a-z0-9.+-]+)/);e(function(){b.path(d[1],!1)}),a.selectedMovie=null,a.filters.moviename="",a.selectedMovieObject=null},a.showSearchResults=function(b,c){a.updateGeoQuery(b,c),v(b,c),a.loading=!1},a.updateGeoQuery=function(a,b){o.updateCriteria({center:[parseFloat(a),parseFloat(b)]})};var u=function(c){c.movie&&c.cinema||e(c.movie?function(){var d=a.map.center.k+"+"+a.map.center.D;b.path(d+"/"+c.movie.url,!1)}:c.cinema?function(){b.path("/cinema/"+c.cinema.url,!1)}:function(){if(a.selectedMovie){var d=_.findWhere(a.movies,{id:a.selectedMovie});b.path("/"+c.coords.lat+"+"+c.coords.lng+"/"+d.url,!1)}else b.path("/"+c.coords.lat+"+"+c.coords.lng,!1)})};a.doSearch=function(b){a.geolocationFailed=!1,a.addressError=!1,b=b?b:a.address,a.loading=!0,f.latLngForAddress(b).then(function(b){i(b),a.updateGeoQuery(b.lat,b.lng),v(b.lat,b.lng),a.loading=!1},function(b){throw a.addressError=!0,a.loading=!1,new Error("Problem geocoding users address",b)})},h();var v=function(c,d){c=c?c:51.5,d=d?d:-.1167,a.map.setCenter(new google.maps.LatLng(c,d)),b.path||u({coords:{lat:c,lng:d}})};v(),a.playerVars={autoplay:1,showinfo:0,controls:1,iv_load_policy:3,rel:0,modestbranding:1},a.youtubePlayer={player:null},a.openTrailer=function(b){a.youtubeId=b.youtube},a.closeTrailer=function(){a.youtubeId=null},navigator.geolocation&&(a.geolocationFeature=!0),a.getLocation=function(){navigator.geolocation?(navigator.geolocation.getCurrentPosition(x,y),a.loading=!0,a.address="Finding you..."):console.warn("Geolocation is not available in this browser, please type your postcode manually")};var w,x=function(b){a.showSearchResults(b.coords.latitude,b.coords.longitude)},y=function(){console.warn("Geolocation failed or permission was denied")},z=function(){g.get().then(function(b){return"not in the uk"===b?void e(function(){a.geolocationFailed=!0}):void a.showSearchResults(b.latitude,b.longitude)})};c.location&&c.movie?(console.info("LOCATION AND MOVIE"),l.orderByChild("url").equalTo(c.movie).on("child_added",function(b){var c=b.val();c.id=b.key(),a.filterCinemas({movie:c.id,updateUrl:!1}),e(function(){a.filters.moviename=c.title})}),w=c.location.match(/([0-9]{2}[0-9.]+)\+([-0-9.]+)/),w?a.showSearchResults(w[1],w[2]):a.doSearch(c.location)):c.cinema&&c.movie?(console.info("CINEMA AND MOVIE",c.cinema,c.movie),l.orderByChild("url").equalTo(c.movie).on("child_added",function(b){var c=b.val();c.id=b.key(),a.filterCinemas({movie:c.id,updateUrl:!1}),e(function(){a.filters.moviename=c.title})}),k.orderByChild("url").equalTo(c.cinema).on("child_added",function(b){var c=b.val();a.cinemas.push(c),a.showSearchResults(c.coords[0],c.coords[1]),a.selectCinema({tid:c.tid,cinema:c,dontReset:!0})})):c.location?(w=c.location.match(/([0-9]{2}[0-9.]+)\+([-0-9.]+)/),w?a.showSearchResults(w[1],w[2]):a.doSearch(c.location)):c.movie?(console.info("MOVIE ONLY"),z(),l.orderByChild("url").equalTo(c.movie).on("child_added",function(b){console.info("got movie",b.val());var c=b.val();c.id=b.key(),a.filterCinemas({movie:c.id,updateUrl:!0}),e(function(){a.filters.moviename=c.title})})):c.cinema?k.orderByChild("url").equalTo(c.cinema).on("child_added",function(b){var c=b.val();a.cinemas.push(c),a.selectCinema({tid:c.tid,cinema:c}),a.showSearchResults(c.coords[0],c.coords[1])}):z()}]),angular.module("cinemaApp").factory("geolocation",["$q","$http",function(a,b){function c(){var c=a.defer();return b.get("http://www.telize.com/geoip").then(function(a){var b={latitude:a.data.latitude,longitude:a.data.longitude};c.resolve(b)}),c.promise}return{get:c}}]),angular.module("cinemaApp").directive("expand",function(){return{restrict:"A",link:function(a,b,c){a.$watch("open",function(a){b.css("height",a?"auto":c.fixedheight)}),b.css("height",c.fixedheight)}}}),angular.module("cinemaApp").directive("fullWidth",function(){return{restrict:"A",link:function(a,b,c){var d=b.parent()[0].offsetWidth-c.margin;b.css({width:d+"px"})}}}),angular.module("cinemaApp").directive("markers",["$compile","$rootScope",function(a){return{restrict:"E",link:function(b,c,d){function e(a){var c=_.findWhere(b.movies,{id:b.selectedMovie}),d=b.selectedDay,e=[];e.push("<strong>Showtimes for "+moment(d).format("dddd")+"</strong>"),e.push(c[a.tid][d]?c[a.tid][d].times.join(", "):"<strong>Not showing here on "+moment(d).format("dddd")+"</strong>"),b.markers[a.tid].movieInfo="<strong>"+a.title+'</strong><br><i>Click for all movies at this cinema</i><ul class="movie-list"><li>'+e.join("</li><li>")+"</li></ul>"}function f(c){var e=new google.maps.Marker({position:{lat:c.coords[0],lng:c.coords[1]},map:b.map,title:c.title,id:c.tid,icon:j}),f=b.movies;if(c.movieDetails=[],c.movieTimes=[],c.movies){var g;if(d.selectedMovie){g=_.findWhere(f,{id:d.selectedMovie});var h=b.selectedDay;c.movieTimes.push("Showtimes for "+moment(h).format("dddd")),c.movieTimes.push(g[c.tid][h]?g[c.tid][h].times.join(", "):"<strong>Not showing here on "+moment(h).format("dddd")+"</strong>")}for(var i=0;i<c.movies.length;i++)g=_.findWhere(f,{id:c.movies[i]}),c.movieDetails.push("<a ng-click=\"filterCinemas({ movie: '"+c.movies[i]+"', cinema: '"+c.tid+"', updateUrl: true })\">"+g.title+"</a>")}e.movieInfo="<div><strong>"+c.title+"</strong><br><i><a ng-click=\"selectCinema({ tid: '"+c.tid+'\', dontReset: true })">Filter by this cinema</a></i><ul class="movie-list"><li>'+c.movieTimes.join("</li><li>")+"</li></ul></div>",e.cinemaInfo="<div><strong>"+c.title+"</strong><br><i><a ng-click=\"selectCinema({ tid: '"+c.tid+'\', dontReset: true })">Filter by this cinema</a></i><ul class="movie-list"><li>'+c.movieDetails.join("</li><li>")+"</li></ul></div>";var k=new google.maps.InfoWindow({maxWidth:230,disableAutoPan:!0});google.maps.event.addListener(e,"click",function(){if(b.selectedMovie){var c=a(e.movieInfo)(b);k.setContent(c[0])}else{var c=a(e.cinemaInfo)(b);k.setContent(c[0])}k.open(b.map,e)}),b.mc.addMarker(e),b.markers[c.tid]=e}function g(a){b.mc.removeMarker(b.markers[a]),b.markers[a].setMap(null),delete b.markers[a]}function h(a,c){return b.markers[a]?void("default"===c?b.markers[a].setIcon(j):"disabled"===c&&b.markers[a].setIcon(k)):void console.error(a,"does not exist")}function i(a){if(a=a||b.filters.moviename,console.log("movie name updated",a),""!==a){console.log(a,"going on");var c=_.filter(b.movies,function(b){var c=b.title.toLowerCase();return c.indexOf(a.toLowerCase())>-1?!0:void 0});console.log("filtered movies result",c);for(var d=0;d<b.cinemas.length;d++)for(var e=0;e<c.length;e++)b.cinemas[d].movies.indexOf(c[e].id)>-1?(console.log(b.cinemas[d].tid,"shwoing"),h(b.cinemas[d].tid,"default")):(console.log(b.cinemas[d].tid,"not showing"),h(b.cinemas[d].tid,"disabled"))}else{console.log("its blank, show them all");for(var d=0;d<b.cinemas.length;d++)h(b.cinemas[d].tid,"default")}}b.markers={},b.prevTids=[];var j="/images/cinema_icons/cinema.png",k="/images/cinema_icons/cinema_disabled.png";b.$watch("filters.moviename",function(){i()}),b.$watch("selectedMovie",function(a,c){var d,h;if(c!==a)if(a){if(a){for(d=0;d<b.cinemaList.length;d++)h=b.cinemaList[d],null!==h&&(_.contains(h.movies,a)?b.markers[h.tid]?e(h):f(h):b.markers[h.tid]&&g(h.tid));i()}}else for(d=0;d<b.cinemaList.length;d++)h=b.cinemaList[d],null!==h&&(b.markers[h.tid]||f(h))}),b.$watch("cinemas",function(a){b.cinemaList=a,a=_.filter(a,function(a){return null!==a?!0:void 0});for(var c=_.difference(_.pluck(a,"tid"),b.prevTids),e=0;e<c.length;e++){var h=_.findWhere(a,{tid:c[e]});(!d.selectedMovie||_.contains(h.movies,d.selectedMovie))&&null!==h&&f(h)}for(var j=_.difference(b.prevTids,_.pluck(a,"tid")),k=0;k<j.length;k++)b.markers[j[k]]&&g(j[k]);b.prevTids=_.pluck(a,"tid"),i()},!0)}}}]),angular.module("cinemaApp").directive("movieTimes",["$compile",function(a){return{restrict:"E",link:function(b,c){function d(a,c,d){b.movie[c.tid][b.selectedDays[a]]&&d.push('<a ng-click="selectDay('+a+');$event.stopPropagation()">'+moment(b.selectedDays[a]).format("dddd")+"</a>")}function e(){if(!b.selectedCinema){for(var e,f=[],g=0;g<b.cinemaList.length;g++)if(e=b.cinemaList[g],b.movie[e.tid])if(b.movie[e.tid][b.selectedDay])f.push('<div class="times-box"><p>'+e.title+" "+moment(b.selectedDay).format("dddd")+"</p><p>"+b.movie[e.tid][b.selectedDay].times.join(" | ")+"</p></div>");else{for(var h=[],i=0;4>i;i++)b.selectedDays[i]!==b.selectedDay&&d(i,e,h);f.push(h.length?'<div class="times-box"><p>'+e.title+"</p><p>Showing "+h.join(", ")+"</i></p></div>":'<div class="times-box"><p>'+e.title+"</p><p><i>Not showing here</i></p>")}return f.unshift('<p class="text-center"><strong>'+moment(b.selectedDay).format("dddd")+" showtimes</strong></p>"),c.html(f),void a(c.contents())(b)}if(!b.movie[b.selectedCinema][b.selectedDay])return c.html('<div class="times-box"><p>Not showing here</p></div>'),c.html(f),void a(c.contents())(b);var e=_.findWhere(b.cinemas,{tid:b.selectedCinema}),f='<p class="text-center"><strong>'+moment(b.selectedDay).format("dddd")+' showtimes</strong></p> <div class="times-box"><p>'+e.title+"</p><p>"+b.movie[b.selectedCinema][b.selectedDay].times.join(" | ")+"</p></div>";c.html(f),a(c.contents())(b)}b.$watch("open",function(a){a&&e()}),b.$watch("selectedCinema",function(){b.open&&e()}),b.$watch("selectedDay",function(){b.open&&e()}),b.$watch("cinemas",function(a){b.open&&(b.cinemaList=a,e())},!0)}}}]);