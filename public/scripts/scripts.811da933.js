"use strict";window.prerenderReady=!1,angular.module("cinemaApp",["ngRoute","geocoder","youtube-embed","angulartics","angulartics.segment.io","angular-lodash","angularMoment","ngPourOver"]).constant("angularMomentConfig",{timezone:"Europe/London"}).config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode({enabled:!0,requireBase:!1}),a.when("/",{templateUrl:"/views/main.html",controller:"MainCtrl"}).when("/cinema/:cinema/:movie",{templateUrl:"/views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).when("/cinema/:cinema",{templateUrl:"/views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).when("/movie/:movie",{templateUrl:"/views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).when("/:location/:movie",{templateUrl:"/views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).when("/:location",{templateUrl:"/views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).otherwise({redirectTo:"/"})}]).config(["$provide",function(a){a.decorator("$q",["$delegate",function(a){var b=a;return b.allComplete=function(a){if(!angular.isArray(a))throw Error("$q.allComplete only accepts an array.");var c=b.defer(),d=0,e=0,f=[];return angular.forEach(a,function(b){b.then(function(a){console.info("done",a),d++,f.push(a)}).catch(function(a){console.error("err",a),e++,f.push(a)}).finally(function(){d+e===a.length&&c.resolve(f)})}),c.promise},b}])}]).run(["$route","$rootScope","$location",function(a,b,c){var d=c.path;c.path=function(e,f){if(f===!1)var g=a.current,h=b.$on("$locationChangeSuccess",function(){a.current=g,h()});return d.apply(c,[e])}}]),angular.module("ngAutocomplete",[]).directive("ngAutocomplete",function(){return{require:"ngModel",scope:{ngModel:"=",options:"=?",details:"=?"},link:function(a,b,c,d){var e,f=!1,g=function(){e={},a.options&&(f=a.options.watchEnter!==!0?!1:!0,a.options.types?(e.types=[],e.types.push(a.options.types),a.gPlace.setTypes(e.types)):a.gPlace.setTypes([]),a.options.bounds?(e.bounds=a.options.bounds,a.gPlace.setBounds(e.bounds)):a.gPlace.setBounds(null),a.options.country?(e.componentRestrictions={country:a.options.country},a.gPlace.setComponentRestrictions(e.componentRestrictions)):a.gPlace.setComponentRestrictions(null))};void 0==a.gPlace&&(a.gPlace=new google.maps.places.Autocomplete(b[0],{})),google.maps.event.addListener(a.gPlace,"place_changed",function(){var c=a.gPlace.getPlace();void 0!==c&&(void 0!==c.address_components?a.$apply(function(){a.details=c,d.$setViewValue(b.val())}):f&&h(c))});var h=function(c){var e=new google.maps.places.AutocompleteService;c.name.length>0&&e.getPlacePredictions({input:c.name,offset:c.name.length},function(c){if(null==c||0==c.length)a.$apply(function(){a.details=null});else{var e=new google.maps.places.PlacesService(b[0]);e.getDetails({reference:c[0].reference},function(c,e){e==google.maps.GeocoderStatus.OK&&a.$apply(function(){d.$setViewValue(c.formatted_address),b.val(c.formatted_address),a.details=c;b.on("focusout",function(){b.val(c.formatted_address),b.unbind("focusout")})})})}})};d.$render=function(){var a=d.$viewValue;b.val(a)},a.watchOptions=function(){return a.options},a.$watch(a.watchOptions,function(){g()},!0)}}}),angular.module("geocoder",["ngStorage"]).factory("Geocoder",["$localStorage","$q","$timeout","$rootScope",function(a,b,c,d){var e=a.locations?JSON.parse(a.locations):{},f=[],g=250,h=function(){console.log("executing next");var b=f[0],i=new google.maps.Geocoder;i.geocode({address:b.address,componentRestrictions:{country:"GB"}},function(i,j){if(console.log("RESULT",i),"United Kingdom"===i[0].formatted_address)f.shift(),b.d.reject({type:"zero",message:"Zero results for geocoding address "+b.address});else if(j===google.maps.GeocoderStatus.OK){var k={lat:i[0].geometry.location.lat(),lng:i[0].geometry.location.lng(),formattedAddress:i[0].formatted_address};e[b.address]=k,a.locations=JSON.stringify(e),f.shift(),b.d.resolve(k)}else j===google.maps.GeocoderStatus.ZERO_RESULTS?(f.shift(),b.d.reject({type:"zero",message:"Zero results for geocoding address "+b.address})):j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT?b.executedAfterPause&&(f.shift(),b.d.reject({type:"busy",message:"Geocoding server is busy can not process address "+b.address})):j===google.maps.GeocoderStatus.REQUEST_DENIED?(f.shift(),b.d.reject({type:"denied",message:"Request denied for geocoding address "+b.address})):(f.shift(),b.d.reject({type:"invalid",message:"Invalid request for geocoding: status="+j+", address="+b.address}));if(f.length)if(j===google.maps.GeocoderStatus.OVER_QUERY_LIMIT){var l=f[0];l.executedAfterPause=!0,c(h,g)}else c(h,0);d.$$phase||d.$apply()})};return{latLngForAddress:function(a){var c=b.defer();return _.has(e,a)?c.resolve(e[a]):(f.push({address:a,d:c}),1===f.length&&h()),c.promise}}}]),angular.module("cinemaApp").directive("errorMessage",["$timeout",function(a){return{template:'<div class="alert-box alert hidden text-center"></div>',restrict:"E",replace:!0,link:function(b,c){b.$on("error",function(){c.removeClass("hidden"),c.text("Sorry, we couldn't find that address"),a(function(){c.addClass("hidden")},2e3)})}}}]),angular.module("cinemaApp").controller("MainCtrl",["$scope","$location","$routeParams","$q","$timeout","Geocoder","geolocation","PourOver",function(a,b,c,d,e,f,g){function h(){var b=new google.maps.LatLng(51.5,-.1167),c={zoom:14,minZoom:10,center:b},d=new google.maps.Map(document.getElementById("map-canvas"),c);a.map=d;var e={maxZoom:16,imageExtension:"png",imagePath:"/images/cinema_icons/cinema-stack"},f=new MarkerClusterer(d,[],e);a.mc=f,google.maps.event.addListener(d,"bounds_changed",function(){var a=this.getBounds(),b=a.getCenter(),c=a.getNorthEast(),d=3963,e=b.lat()/57.2958,f=b.lng()/57.2958,g=c.lat()/57.2958,h=c.lng()/57.2958,i=d*Math.acos(Math.sin(e)*Math.sin(g)+Math.cos(e)*Math.cos(g)*Math.cos(h-f)),j=1.609344*i;n.updateCriteria({radius:j})}),google.maps.event.addListener(d,"dragend",function(){o(),a.updateGeoQuery(this.center.k,this.center.D),t({coords:{lat:this.center.k,lng:this.center.D}})}),google.maps.event.addListener(d,"zoom_changed",function(){a.updateGeoQuery(this.center.k,this.center.D),t({coords:{lat:this.center.k,lng:this.center.D}})})}var i=new Firebase("https://movielistings.firebaseio.com/"),j=i.child("cinemas"),k=i.child("movies"),l=new GeoFire(i.child("cinemasGeofire")),m=2.813,n=l.query({center:[51.5,-.1167],radius:m});a.filters={moviename:""},a.$watch("filters.moviename",function(){a.selectedMovie=null}),a.selectedMovie=null,a.selectedCinema=null,a.selectedDay=moment().startOf("day").valueOf(),a.selectedDayIndex=0,a.tomorrowPlus1=moment().startOf("day").add(2,"days").format("dddd"),a.tomorrowPlus2=moment().startOf("day").add(3,"days").format("dddd"),a.movieIds=[],a.movies=[],a.cinemas=[],a.cinemaMovies={},a.selectCinema=function(b){b.dontReset||a.resetFilters();var c;b.cinema||(c=_.findWhere(a.cinemas,{tid:b.tid}),t({cinema:c})),a.selectedCinema=b.tid,a.selectedCinemaObject=b.cinema||c,b.cinema&&console.log("added",b.cinema.title),a.$apply()};var o=function(){a.selectedCinema=null};a.resetFilters=function(){console.log("resetting"),a.selectedCinema=null,a.selectedMovie=null,a.filters.moviename=""},a.$on("selectedCinema",function(b,c){a.selectCinema({tid:c})}),a.filterByMovieIds=function(b){return a.movieIds.indexOf(b.id)>-1?!0:void 0},a.filterBySelectedCinema=function(b){return a.selectedCinema?b[a.selectedCinema]?!0:void 0:!0},a.selectDay=function(b){a.selectedDay=moment().add(b,"days").startOf("day").valueOf(),a.selectedDayIndex=parseInt(b,10)},n.on("key_entered",function(b){j.child(b).on("value",function(b){var c=b.val();if(null!==c&&!_.findWhere(a.cinemas,{tid:c.tid})){if(a.cinemas.push(c),c.movies)for(var d=0;d<c.movies.length;d++)a.movieIds.push(c.movies[d]);a.$apply()}})}),n.on("key_exited",function(b){j.child(b).on("value",function(b){var c=b.val(),d=_.findWhere(a.cinemas,{tid:c.tid});if(a.cinemas.splice(a.cinemas.indexOf(d),1),null!==c&&c.movies)for(var e=0;e<c.movies.length;e++)c.movies[e]!==a.selectedMovie&&a.movieIds.splice(a.movieIds.indexOf(c.movies[e]),1)})}),k.on("child_added",function(b){var c=b.val();c.id=b.key(),a.movies.push(c),a.$apply()});var p=function(a){return a.rt?"number"!=typeof a.rt.rating?-1:a.rt.rating:-1},q=function(a){if(!a.imdb)return-1;var b=parseFloat(a.imdb.rating);return"number"!=typeof b?-1:b},r=function(a){return a.rt.releaseDate?a.rt.releaseDateTimestamp:-1},s=function(a){return a.rt.releaseDate?-a.rt.releaseDateTimestamp:-1};a.filterFns=[{l:"Rotten Tomatoes rating",fn:p},{l:"IMDB rating",fn:q},{l:"Newest movies first",fn:r},{l:"Oldest movies first",fn:s}],a.filterFn=p,a.filterCinemas=function(b){b.updateUrl,a.selectedMovie=b.movie.id,a.filters.moviename=b.movie.title,a.selectedMovieObject=b.movie,console.log("set selected movie",a.selectedMovie),e(function(){})},a.unfilterCinemas=function(){var c=b.path(),d=c.match(/^(\/[a-z0-9.+-]+)/);e(function(){b.path(d[1],!1)}),a.selectedMovie=null,a.filters.moviename="",a.selectedMovieObject=null},a.showSearchResults=function(b,c){a.updateGeoQuery(b,c),u(b,c),a.loading=!1},a.updateGeoQuery=function(a,b){n.updateCriteria({center:[parseFloat(a),parseFloat(b)]})};var t=function(c){c.movie&&c.cinema||e(c.movie?function(){var a=b.path(),d=a.match(/^(\/[a-z0-9.+-]+)/);b.path(d[1]+"/"+c.movie.url,!1)}:c.cinema?function(){b.path("/cinema/"+c.cinema.url,!1)}:function(){if(a.selectedMovie){var d=_.findWhere(a.movies,{id:a.selectedMovie});b.path("/"+c.coords.lat+"+"+c.coords.lng+"/"+d.url,!1)}else b.path("/"+c.coords.lat+"+"+c.coords.lng,!1)})};a.doSearch=function(b){a.addressError=!1,b=b?b:a.address,a.loading=!0,f.latLngForAddress(b).then(function(b){a.updateGeoQuery(b.lat,b.lng),u(b.lat,b.lng),a.loading=!1},function(b){throw a.addressError=!0,a.loading=!1,new Error("Problem geocoding users address",b)})},h();var u=function(c,d){c=c?c:51.5,d=d?d:-.1167,a.map.setCenter(new google.maps.LatLng(c,d)),b.path||t({coords:{lat:c,lng:d}})};u(),a.playerVars={autoplay:1,showinfo:0,controls:1,iv_load_policy:3,rel:0,modestbranding:1},a.youtubePlayer={player:null},a.openTrailer=function(b){a.youtubeId=b.youtube},a.closeTrailer=function(){a.youtubeId=null},navigator.geolocation&&(a.geolocationFeature=!0),a.getLocation=function(){navigator.geolocation?(navigator.geolocation.getCurrentPosition(w,x),a.loading=!0,a.address="Finding your address automatically..."):console.log("Geolocation is not available in this browser, please type your postcode manually")};var v,w=function(b){a.showSearchResults(b.coords.latitude,b.coords.longitude)},x=function(){console.log("Geolocation failed or permission was denied")},y=function(){g.get().then(function(b){a.showSearchResults(b.latitude,b.longitude)})};c.location&&c.movie?(console.log("LOCATION AND MOVIE"),k.orderByChild("url").equalTo(c.movie).on("child_added",function(b){var c=b.val();c.id=b.key(),a.filterCinemas({movie:c,updateUrl:!1}),e(function(){a.filters.moviename=c.title})}),v=c.location.match(/([0-9]{2}[0-9.]+)\+([-0-9.]+)/),v?a.showSearchResults(v[1],v[2]):a.doSearch(c.location)):c.cinema&&c.movie?(console.log("CINEMA AND MOVIE",c.cinema,c.movie),k.orderByChild("url").equalTo(c.movie).on("child_added",function(b){var c=b.val();console.log("got movie",c),c.id=b.key(),a.filterCinemas({movie:c,updateUrl:!1}),e(function(){a.filters.moviename=c.title})}),j.orderByChild("url").equalTo(c.cinema).on("child_added",function(b){var c=b.val();a.cinemas.push(c),a.showSearchResults(c.coords[0],c.coords[1]),a.selectCinema({tid:c.tid,cinema:c,dontReset:!0})})):c.location?(v=c.location.match(/([0-9]{2}[0-9.]+)\+([-0-9.]+)/),v?a.showSearchResults(v[1],v[2]):a.doSearch(c.location)):c.movie?(console.log("MOVIE ONLY"),y(),k.orderByChild("url").equalTo(c.movie).on("child_added",function(b){console.log("got movie",b.val());var c=b.val();c.id=b.key(),a.filterCinemas({movie:c,updateUrl:!0}),e(function(){a.filters.moviename=c.title})})):c.cinema?j.orderByChild("url").equalTo(c.cinema).on("child_added",function(b){var c=b.val();a.cinemas.push(c),a.selectCinema({tid:c.tid,cinema:c}),a.showSearchResults(c.coords[0],c.coords[1])}):y()}]),angular.module("cinemaApp").factory("geolocation",["$q","$http",function(a,b){function c(){var c=a.defer();return b.get("http://www.telize.com/geoip").then(function(a){var b={latitude:a.data.latitude,longitude:a.data.longitude};c.resolve(b)}),c.promise}return{get:c}}]),angular.module("cinemaApp").directive("expand",function(){return{restrict:"A",link:function(a,b,c){a.$watch("open",function(a){b.css("height",a?"auto":c.fixedheight)}),b.css("height",c.fixedheight)}}}),angular.module("cinemaApp").directive("fullWidth",function(){return{restrict:"A",link:function(a,b,c){var d=b.parent()[0].offsetWidth-c.margin;b.css({width:d+"px"})}}}),angular.module("cinemaApp").directive("markers",["$rootScope",function(a){return{restrict:"E",link:function(b,c,d){function e(a){var c=_.findWhere(b.movies,{id:d.selectedMovie}),e=b.selectedDay,f=[];f.push("<strong>Showtimes for "+moment(e).format("dddd")+"</strong>"),f.push(c[a.tid][e]?c[a.tid][e].times.join(", "):"<strong>Not showing here on "+moment(e).format("dddd")+"</strong>"),b.markers[a.tid].movieInfo="<strong>"+a.title+'</strong><br><i>Click for all movies at this cinema</i><ul class="movie-list"><li>'+f.join("</li><li>")+"</li></ul>"}function f(c){var e=new google.maps.Marker({position:{lat:c.coords[0],lng:c.coords[1]},map:b.map,title:c.title,id:c.tid,icon:"/images/cinema_icons/cinema.png"}),f=JSON.parse(d.movies);if(c.movieDetails=[],c.movieTimes=[],c.movies){var g;if(d.selectedMovie){g=_.findWhere(f,{id:d.selectedMovie});var h=b.selectedDay;c.movieTimes.push("Showtimes for "+moment(h).format("dddd")),c.movieTimes.push(g[c.tid][h]?g[c.tid][h].times.join(", "):"<strong>Not showing here on "+moment(h).format("dddd")+"</strong>")}for(var i=0;i<c.movies.length;i++)g=_.findWhere(f,{id:c.movies[i]}),c.movieDetails.push(g.title)}e.movieInfo="<strong>"+c.title+'</strong><br><i>Click icon to filter by this cinema</i><ul class="movie-list"><li>'+c.movieTimes.join("</li><li>")+"</li></ul>",e.cinemaInfo="<strong>"+c.title+'</strong><br><i>Click icon to filter by this cinema</i><ul class="movie-list"><li>'+c.movieDetails.join("</li><li>")+"</li></ul>";var j=new google.maps.InfoWindow({maxWidth:230,disableAutoPan:!0});google.maps.event.addListener(e,"mouseover",function(){j.setContent(b.selectedMovie?e.movieInfo:e.cinemaInfo),j.open(b.map,e)}),google.maps.event.addListener(e,"mouseout",function(){j.close(b.map,e)}),google.maps.event.addListener(e,"click",function(){a.$broadcast("selectedCinema",c.tid)}),b.mc.addMarker(e),b.markers[c.tid]=e}function g(a){b.mc.removeMarker(b.markers[a]),b.markers[a].setMap(null),delete b.markers[a]}b.markers={},b.prevTids=[],d.$observe("selectedMovie",function(a){var c,d;if(a){if(a)for(c=0;c<b.cinemaList.length;c++)d=b.cinemaList[c],null!==d&&(_.contains(d.movies,a)?b.markers[d.tid]?e(d):f(d):b.markers[d.tid]&&g(d.tid))}else for(c=0;c<b.cinemaList.length;c++)d=b.cinemaList[c],null!==d&&(b.markers[d.tid]||f(d))}),d.$observe("cinemas",function(a){a=JSON.parse(a),b.cinemaList=a,a=_.filter(a,function(a){return null!==a?!0:void 0});for(var c=_.difference(_.pluck(a,"tid"),b.prevTids),e=0;e<c.length;e++){var h=_.findWhere(a,{tid:c[e]});(!d.selectedMovie||_.contains(h.movies,d.selectedMovie))&&null!==h&&f(h)}for(var i=_.difference(b.prevTids,_.pluck(a,"tid")),j=0;j<i.length;j++)b.markers[i[j]]&&g(i[j]);b.prevTids=_.pluck(a,"tid")})}}}]),angular.module("cinemaApp").directive("movieTimes",function(){return{template:"<div></div>",restrict:"E",link:function(a,b){function c(){if(!a.selectedCinema){for(var c,d="",e=0;e<a.cinemas.length;e++)c=a.cinemas[e],a.movie||(d+='<div class="times-box"><p>Showtimes for '+c.title+" today</p><p>"+a.movie[c.tid][a.selectedDay].times.join(" | ")+"</p></div>");b.html(d),console.log("should show",d)}if(!a.movie[a.selectedCinema][a.selectedDay])return void b.html('<div class="times-box"><p>Not showing here on '+moment(a.selectedDay).format("dddd")+"</p></div>");var c=_.findWhere(a.cinemas,{tid:a.selectedCinema}),d='<div class="times-box"><p>Showtimes for '+c.title+" today</p><p>"+a.movie[a.selectedCinema][a.selectedDay].times.join(" | ")+"</p></div>";b.html(d)}a.$watch("selectedCinema",function(){c()}),c()}}});